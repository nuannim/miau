<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/index.css">
    <link href='https://fonts.googleapis.com/css?family=Kanit' rel='stylesheet'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <title>Document</title>
</head>
<body>
    <main>
        <div class="box" id="example">
            <div id="volumn" onclick="playAudio()"><img src="images/volume-up_4774916.png" alt="volumn"></div>
            <div id="e-sentence"></div>
        </div>
        <div class="box" id="result">
            <div class="text">
                <div id="prop"></div>
            </div>
            <div id="r-sentence"></div>
            <div id="redo">
                <div id="mic">
                    <img src="images/mic_8473359.png" alt="">
                </div>
                <img src="images/undo_7435085.svg" alt="redo">
            </div>
        </div>
        <div id="done">Next</div>
        <div class="archive" onclick="togglePopup()"><img src="images/target_11091578.png" alt=""></div>
        <div id="popup" class="popup">
            <div class="popup-content">
                <span class="close" onclick="togglePopup()">&times;</span>
                <p>วันนี้คุณทำแบบฝึกหัดสำเร็จไป 1 ข้อ!</p>
            </div>
        </div>
    </main>
    <script>
////////////////////////////////////////////////// front
        function togglePopup() {
            var popup = document.getElementById("popup");
            if (popup.style.display === "block") {
                popup.style.display = "none";
            } else {
                popup.style.display = "block";
            }
        }
////////////////////////////////////////////////// noeysod
    const recordButton = document.getElementById("mic");
    const doneButton = document.getElementById("done")

    let mediaRecorder;
    let audioChunks = [];
    let mic = 0;

    recordButton.onclick = async () => {
      if (mic === 0) {
        startRecording();
      } else {
        stopRecording();
      }
    };

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      
      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const audioUrl = URL.createObjectURL(audioBlob);
        // audioPlayback.src = audioUrl; 
        // audioPlayback.load();
        audioChunks = []; 

        // Send the audioBlob to the FastAPI server 
        const formData = new FormData();
        formData.append('file_stt', audioBlob, 'audio.wav'); 
        try { 
          const response = await fetch(
                        'http://localhost:8000/upload', 
                        { 
                          method: 'POST', 
                          body: formData 
                        }
                      ); 
          const result = await response.json(); 
          console.log(result.message); 
          displayWord(result.message);
        } catch (error) { 
          console.error('Error:', error); 
        }
      };

      mediaRecorder.start();
    //   recordButton.textContent = "Stop Recording";
      mic = 1;

    }

    async function stopRecording() {
      mediaRecorder.stop();
    //   recordButton.textContent = "Start Recording";
        mic = 0;
    }


    async function sendIndexToServer(index) {
        const formData = new FormData();
        formData.append('index', index);
        
        try {
            const response = await fetch('http://localhost:8000/send_index', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Server response:', result.message);
                // Navigate to the home page after successfully sending the index
                displayWord(result.message2);
                // window.location.href = "http://localhost:8000/";
            } else {
                console.error('Server response:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    document.getElementById("done").addEventListener("click", () => {
        sendIndexToServer(index);
        stepIndex();
    });


////////////////////////////////////////////////// cj
    // เอาไว้นับตำแหน่ง กับเก็บ เจสัน อิอิอิอิอิ แอ่ว
    let index = 0;
    // let array = [];

    // function fetchJSON() {
    //         fetch('/css/sentences.json')
    //             .then(response => {
    //                 if (!response.ok) {
    //                     throw new Error('Network response was not ok');
    //                 }
    //                 return response.json();
    //             })
    //             .then(data => {
    //                 array = data.sentences;
    //                 showtext();
    //                 // sendIndexToServer(index);
    //             })
    //             .catch(error => {
    //                 console.error('Error fetching JSON:', error);
    //                 document.getElementById("e-sentence").textContent = 'Error loading JSON data';
    //             });
    //     }

    // function showtext(){
    //     const insideword = document.getElementById("e-sentence");
    //     // insideword.textContent = array[index];
    //     insideword.textContent = word;
    //     // insideword.innerHTML = 
    // }

    function stepIndex() {
            if (index < 2) {
                index++;
                // showtext();
            }
            else {
                index = 0;
                // showtext();
            }
            // showtext();
        }

    function displayWord(word) { 
        const resultElement = document.getElementById("e-sentence");
        resultElement.textContent = word; 
    }



    document.getElementById("done").addEventListener("click", stepIndex);
    // showtext(myList.mylist[index]);

    displayWord(myList.mylist[index]);
    // fetchJSON();

    </script>
</body>
</html>